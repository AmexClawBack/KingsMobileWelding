<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Content Manager</title>
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tell Decap we will initialize it manually -->
    <script>window.CMS_MANUAL_INIT = true;</script>

    <!-- Load Decap CMS from unpkg, with a jsDelivr fallback -->
    <script>
      (function loadDecap() {
        var primary = document.createElement('script');
        primary.src = "https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js";
        primary.async = false; // ensure order
        primary.onload = function () { window.__DECAP_LOADED__ = true; };
        primary.onerror = function () {
          var fallback = document.createElement('script');
          fallback.src = "https://cdn.jsdelivr.net/npm/decap-cms@^3.0.0/dist/decap-cms.js";
          fallback.async = false;
          fallback.onload = function () { window.__DECAP_LOADED__ = true; };
          document.head.appendChild(fallback);
        };
        document.head.appendChild(primary);
      })();
    </script>

    <script>
      // Inline config so we bypass YAML parsing issues
      const decapConfig = {
        load_config_file: false,
        backend: {
          name: 'github',
          repo: 'AmexClawBack/KingsMobileWelding',
          branch: 'main',
          base_url: 'https://netlify-cms-github-oauth-provider-cdue.onrender.com',
          auth_endpoint: '/auth'
        },
        media_folder: 'assets/uploads',
        public_folder: '/assets/uploads',
        publish_mode: 'simple',
        collections: [
          {
            label: 'Blog',
            name: 'blog',
            folder: '_posts',
            create: true,
            slug: '{{year}}-{{month}}-{{day}}-{{slug}}',
            extension: 'md',
            format: 'frontmatter',
            fields: [
              { label: 'Title', name: 'title', widget: 'string' },
              { label: 'Publish Date', name: 'date', widget: 'datetime' },
              { label: 'Description', name: 'description', widget: 'text', required: false },
              { label: 'Cover Image', name: 'cover', widget: 'image', required: false },
              { label: 'Tags', name: 'tags', widget: 'list', required: false },
              { label: 'Body', name: 'body', widget: 'markdown' }
            ]
          }
        ]
      };

      // Start Decap only after:
      // 1) DOM is ready, and
      // 2) the decap-cms.js script has loaded and window.CMS exists.
      function startCMS() {
        if (window.__DECAP_LOADED__ && window.CMS) {
          // Optional: load your site CSS into the preview pane
          // CMS.registerPreviewStyle('/assets/css/main.css');
          CMS.init({ config: decapConfig });
        } else {
          setTimeout(startCMS, 50);
        }
      }

      document.addEventListener('DOMContentLoaded', startCMS);
    </script>
  </head>
  <body></body>
</html>
